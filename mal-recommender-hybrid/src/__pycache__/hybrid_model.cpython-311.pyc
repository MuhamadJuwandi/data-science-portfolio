Â§
    
#(i0"  Ã£                   Ã³Ãº  â€” d Z ddlZddlZddlmZ ddl mZ ddl	m
Z
 ddl
mZ ddl
Z
ddlZ ej        ej        d Â¬Â¦  Â«          ej        eÂ¦  Â«        Z G d	â€ d
Â¦  Â«        Zed
k    râ€“ eÂ¦   Â«         ZeÂ                     Â¦   Â«          eÂ                     Â¦   Â«          eÂ                     Â¦   Â«          ej        d         j        d         Z ed
eâ€º ÂÂ¦  Â«         eÂ                     eÂ¦  Â«        Z eeddg         Â¦  Â«         dS dS )zÃ®
Hybrid Recommender Model Module.

Combines Collaborative Filtering (SVD) and Content-Based Filtering (TF-IDF)
to provide personalized anime recommendations.
Uses scikit-learn for SVD to avoid compilation issues with Surprise on Windows.
Ã©    N)ÃšTruncatedSVD)ÃšTfidfVectorizer)Ãš
linear_kernel)Ãš
csr_matrixz)%(asctime)s - %(levelname)s - %(message)s)ÃšlevelÃšformatc                   Ã³8   â€” e Zd Zd
dâ€Zdâ€ Zdâ€ Zdâ€ Zd
dâ€Z dd	â€ZdS )
ÃšHybridRecommenderNc                  Ã³â‚¬  â€” |r|n_t           j        Â                     t           j        Â                     t           j        Â                     t          Â¦  Â«        Â¦  Â«        ddÂ¦  Â«        | _        d| _        d| _         d| _        d| _	        d| _
        d| _
        d| _        d| _
        d| _        d| _        d| _        d| _        dS )zÅ 
        Initialize the Hybrid Recommender.
        
        Args:
            data_path (str): Path to processed data directory.
        ÃšdataÃš	processedN)ÃšosÃšpathÃšjoinÃš dirnameÃš__file__Ãš	data_pathÃšanime_dfÃštrain_dfÃšcf_modelÃštfidf_matrixÃš indicesÃš
user_mapperÃšanime_mapperÃšuser_inv_mapperÃšanime_inv_mapperÃšuser_item_matrixÃšuser_factorsÃšitem_factors)Ãšselfr   s     ÃºUC:\Users\muham\.gemini\antigravity\scratch\mal-recommender-hybrid\src\hybrid_model.pyÃš__init__zHybridRecommender.__init__   sÂ¸   â‚¬ Ã° '0Ã°  CËœËœÂµRÂ´WÂ·\Â²\Ã…"Ã„'Ã‡/Ã‚/Ã•RTÃ”RYÃ—RaÃ’RaÃ•bjÃ‘RkÃ”RkÃ‘BlÃ”BlÃntÃ°  wBÃ±  6CÃ´  6CË†Å’Ã˜Ë†Å’
Ã˜Ë†Å’
Ã˜Ë†Å’
Ã˜ Ë†Ã”Ã˜Ë†Å’Ã˜Ë†Ã”Ã˜ Ë†Ã”Ã˜#Ë†Ã”Ã˜ $Ë†Ã”Ã˜ $Ë†Ã”Ã˜ Ë†Ã”Ã˜ Ë†Ã”ÃÃÃ³    c                 Ã³Â®  â€” t           Â                     dÂ¦  Â«         t          j        t          j        Â                     | j         dÂ¦  Â«        Â¦  Â«        | _        t          j        t          j        Â                     | j         dÂ¦  Â«        Â¦  Â«        | _	        t          j
        | j        j
        | j        d         Â¬Â¦  Â«        Â                     Â¦   Â«         | _
        dS ) zLoad processed parquet files.zLoading data for model...zanime_processed.parquetz
train.parquetÃšanime_id)ÃšindexN)ÃšloggerÃšinfoÃšpdÃšread_parquetr   r   r   r   r   r   ÃšSeriesr&   Ãšdrop_duplicatesr   )r    s    r!   Ãš	load_datazHybridRecommender.load_data,   sÂ   â‚¬ Ã¥Â
Å 
Ã/Ã‘0Ã”0Ã0ÃÅ“Â­Â¬ Â¯ÂªÂ°TÂ´^ÃE^Ã‘(_Ã”(_Ã‘`Ã”`Ë†Å’
ÃÅ“Â­Â¬ Â¯ÂªÂ°TÂ´^Ã€_Ã‘(UÃ”(UÃ‘VÃ”VË†Å’
Ãµ â€yÂ Â¤Ã”!4Â¸DÂ¼MÃˆ*Ã”<UÃVÃ‘VÃ”VÃ—fÃ’fÃ‘hÃ”hË†Å’Ë†Ë†r#   c                  Ã³Ã¶  â€” t           Â                     dÂ¦  Â«         | j        d         Â                     Â¦   Â«         }| j        d         Â                     Â¦   Â«         }dâ€ t	          |Â¦  Â«        D Â¦   Â«         | _        dâ€ t	          |Â¦  Â«        D Â¦   Â«         | _        dâ€ | j        Â                      Â¦   Â«         D Â¦   Â«         | _        d â€ | j        Â                      Â¦   Â«         D Â¦   Â«         | _	        | j        d         Â 
                    | j        Â¦  Â«        }| j        d         Â 
                    | j        Â¦  Â«        }t          | j        d         ||fft          |Â¦  Â«        t          |Â¦  Â«        fÂ¬	Â¦  Â«        | _
        t          d
d
Â¬Â¦  Â«        | _        | j        Â                     | j
        Â¦  Â«         | j        Â                     | j
        Â¦  Â«        | _        | j        j        j        | _        t           Â                     d
Â¦  Â«         dS )z=Build and train Collaborative Filtering model (TruncatedSVD).z/Building Collaborative Filtering model (SVD)...Ãšusernamer%   c                 Ã³   â€” i | ]\  }}||â€œÅ’	S Â© r1   )Ãš.0ÃšiÃšusers      r!   Ãº
<dictcomp>z4HybridRecommender.build_cf_model.<locals>.<dictcomp>>   s   â‚¬ ÃKÃKÃKÂ© Â¨Â¨4ËœDÂ !ÃKÃKÃKr#   c                 Ã³   â€” i | ]\  }}||â€œÅ’	S r1   r1   )r2   r3   Ãšanimes      r!   r5   z4HybridRecommender.build_cf_model.<locals>.<dictcomp>?   s   â‚¬ ÃNÃNÃNÂ©(Â¨!Â¨UËœUÂ AÃNÃNÃNr#   c                 Ã³   â€” i | ]\  }}||â€œÅ’	S r1   r1   )r2   r4   r3   s      r!   r5   z4HybridRecommender.build_cf_model.<locals>.<dictcomp>@   s   â‚¬ ÃPÃPÃPÂ©GÂ¨DÂ°!Â Â 4ÃPÃPÃPr#   c                 Ã³   â€” i | ]\  }}||â€œÅ’	S r1   r1   )r2   r7   r3   s      r!   r5   z4HybridRecommender.build_cf_model.<locals>.<dictcomp>A   s   â‚¬ Ã TÃ TÃ TÂ©hÂ¨eÂ°QÂ Â EÃ TÃ TÃ Tr#   Ãšmy_score)ÃšshapeÃ©   Ã©*   )Ãšn_componentsÃšrandom_statezCF model trained.N)r'   r(   r   ÃšuniqueÃš	enumerater   r   Ãšitemsr   r   Ãšmapr   Ãšlenr   r   r   ÃšfitÃš	transformr   Ãš
components_ÃšTr   )r    Ãšunique_usersÃšunique_animeÃšuser_indicesÃš
anime_indicess        r!   Ãšbuild_cf_modelz HybridRecommender.build_cf_model5   sÂ½  â‚¬ Ã¥Â
Å 
ÃEÃ‘FÃ”FÃFÃ° â€}Â ZÃ”0Ã—7Ã’7Ã‘9Ã”9Ë†Ã˜â€}Â ZÃ”0Ã—7Ã’7Ã‘9Ã”9Ë†Ã KÃKÂµ9Â¸\Ã‘3JÃ”3JÃKÃ‘KÃ”KË†Ã”Ã˜NÃNÂµiÃ€Ã‘6MÃ”6MÃNÃ‘NÃ”NË†Ã”Ã˜PÃPÂ°tÃ”7GÃ—7MÃ’7MÃ‘7OÃ”7OÃPÃ‘PÃ”PË†Ã”Ã˜ TÃ TÂ¸$Ã”:KÃ—:QÃ’:QÃ‘:SÃ”:SÃ TÃ‘ TÃ” TË†Ã”Ã â€}Â ZÃ”0Ã—4Ã’4Â°TÃ”5EÃ‘FÃ”FË†Ã˜Å“
Â jÃ”1Ã—5Ã’5Â°dÃ”6GÃ‘HÃ”HË†
Ã¥ *Ã˜
Å’]Ëœ:Ã”
&Â¨Â°}Ã(EÃFÃÂ|Ã‘$Ã”$Â¥cÂ¨,Ã‘&7Ã”&7Ã8Ã°!
Ã± !
Ã´ !
Ë†Ã”Ãµ %Â°"Ã€2ÃFÃ‘FÃ”FË†Å’
Ã˜Å’
Ã—Ã’Ëœ$Ã”/Ã‘0Ã”0Ã0Ã  Å“MÃ—3Ã’3Â°DÃ”4IÃ‘JÃ”JË†Ã”Ã˜ Å“MÃ”5Ã”7Ë†Ã”Ã¥Â
Å 
Ã'Ã‘(Ã”(Ã(Ã(Ã(r#   c                 Ã³&  â€” t           Â                     dÂ¦  Â«         | j        d         dz   | j        d         z   | j        d<   t           dd Â¬Â¦  Â«        }|Â                     | j        d         Â¦  Â«        | _        t           Â                     d	Â¦  Â«         d
S )
z1Build Content-Based model using TF-IDF on Genres.zBuilding Content-Based model...ÃšgenreÃš ÃštitleÃš contentÃš englishiË†  )Ãš
stop_wordsÃšmax_featuresz'CB model built (TF-IDF matrix created).N)r'   r(   r   r   Ãš
fit_transformr   )r    Ãštfidfs     r!   Ãšbuild_cb_modelz HybridRecommender.build_cb_modelT   sâ€š   â‚¬ Ã¥Â
Å 
Ã5Ã‘6Ã”6Ã6Ã #'Â¤=Â°Ã”#9Â¸CÃ‘#?Ã€$Ã„-ÃPWÃ”BXÃ‘#XË†Å’
ÂiÃ‘ Ã¥Â¨9Ã€4ÃHÃ‘HÃ”HË†Ã˜!Ã—/Ã’/Â°Â´
Â¸iÃ”0HÃ‘IÃ”IË†Ã”Ã¥Â
Å 
Ã=Ã‘>Ã”>Ã>Ã>Ã>r#   Ã©
   Ã§333333Ã£?c                 Ã³Å“  â€¡ â€¡â€” |â€° j         vr3t          Â                     d|â€º dÂÂ¦  Â«         â€° Â                     |Â¦  Â«        S â€° j         |         }t	          j        â€° j        |         â€° j         j        Â¦  Â«        }â€° j	        |         j
        Å Ë†fdâ€t          t          â€° j
        Â¦  Â«        Â¦  Â«        D Â¦   Â«         }Ë† fdâ€|D Â¦   Â«         } ||         }t          j        | |dÅ“Â¦  Â«        }	|	Â                     dd Â¬Â¦  Â«        Â                     d	Â¦  Â«        }	Ë† fd
â€â€°D Â¦   Â«         }
Ë† fd
â€|
D Â¦   Â«         }
|
rÃ‰t	          j        t	          j        â€° j        |
         dÂ¬
Â¦  Â«        Â¦  Â«        }Ë† fdâ€|	d         D Â¦   Â«         }
t          |
Â¦  Â«        t          |	Â¦  Â«        k    rVt+          |â€° j        |
         Â¦  Â«        Â                     Â¦   Â«         }dd|z  z   |	d<   ||	d         z  d|z
  |	d         z  z   |	d<   n|	d         |	d<   n
|	d         |	d<   |	Â                     dd Â¬Â¦  Â«        Â                     |Â¦  Â«        }|Â                     â€° j        dÂ¬Â¦  Â«        }|g dÂ¢         S )z2
        Generate hybrid recommendations.
        zUser z. not found. Returning popular recommendations.c                 Ã³   â€¢â€” g | ]}|â€°vÂ¯|â€˜Å’	S r1   r1   )r2   r3   Ãšwatched_indicess     â‚¬r!   Ãº
<listcomp>z/HybridRecommender.recommend.<locals>.<listcomp>z   s$   Ã¸â‚¬ ÃbÃbÃbÂ 1ÃˆÃRaÃIaÃIaËœQÃIaÃIaÃIar#   c                 Ã³*   â€¢â€” g | ]}â€°j         |         â€˜Å’S r1   Â©r   Â©r2   r3   r    s     â‚¬r!   r^   z/HybridRecommender.recommend.<locals>.<listcomp>~   s!   Ã¸â‚¬ ÃSÃSÃSÂ¸AËœtÃ”4Â°QÃ”7ÃSÃSÃSr#   )r%   Ãšcf_scorerb   FÂ©Ãš	ascendingÃ©d   c                 Ã³*   â€¢â€” g | ]}â€°j         |         â€˜Å’S r1   r`   ra   s     â‚¬r!   r^   z/HybridRecommender.recommend.<locals>.<listcomp>â€™   s!   Ã¸â‚¬ ÃOÃOÃOÂ¸!ËœTÃ”2Â°1Ã”5ÃOÃOÃOr#   c                 Ã³<   â€¢â€” g | ]}|â€°j         v Â¯
â€°j         |         â€˜Å’S r1   Â©r   Â©r2   Ãšaidr    s     â‚¬r!   r^   z/HybridRecommender.recommend.<locals>.<listcomp>â€œ   s/   Ã¸â‚¬ Ã gÃ gÃ gÂ°sÃSVÃZ^Ã”ZfÃSfÃSfÂ Â¤Â¨cÃ”!2ÃSfÃSfÃSfr#   r   )Ãšaxisc                 Ã³<   â€¢â€” g | ]}|â€°j         v Â¯
â€°j         |         â€˜Å’S r1   rh   ri   s     â‚¬r!   r^   z/HybridRecommender.recommend.<locals>.<listcomp>â„¢   s/   Ã¸â‚¬ Ã&oÃ&oÃ&oÂ¸SÃ[^ÃbfÃ”bnÃ[nÃ[nÂ tÂ¤|Â°CÃ”'8Ã[nÃ[nÃ[nr#   r%   Ã©   Ã©	   Ãšcb_scoreÃšhybrid_score)Ãšon)r%   rQ   rO   Ãšscorerp   Ãš	image_url)r   r'   r(   Ãšget_popular_recommendationsÃšnpÃšdotr   r   rH   r   r   ÃšrangerD   r   r)   Ãš	DataFrameÃš
sort_valuesÃšheadÃš asarrayÃšmeanr   r   Ãš flattenÃšmerger   )r    Ãš user_idÃšn_recommendationsÃšalphaÃšuser_idxÃš	cf_scoresÃšcandidate_indicesÃšcandidate_anime_idsÃšcandidate_scoresÃš recs_dfÃšwatched_anime_idsÃšwatched_tfidf_indicesÃšuser_profileÃšcandidate_tfidf_indicesÃš	cb_scoresÃštop_recsÃšresultr]   s   `                @r!   Ãš	recommendzHybridRecommender.recommend_   sÂ¢  Ã¸Ã¸â‚¬ Ã°
 Ëœ$Ã”*Ã
*Ã
*ÃÂKÅ KÃWÂ  ÃWÃWÃWÃ‘XÃ”XÃXÃ˜Ã—3Ã’3Ã4EÃ‘FÃ”FÃFÃ° Ã”#Â GÃ”,Ë†Ãµ â€FËœ4Ã”,Â¨XÃ”6Â¸Ã”8IÃ”8KÃ‘LÃ”LË†	Ã° Ã”/Â°Ã”9Ã”AË†Ã° cÃbÃbÃbÂ­Â­cÂ°$Ã”2CÃ‘.DÃ”.DÃ‘(EÃ”(EÃbÃ‘bÃ”bÃÃ° TÃSÃSÃSÃARÃSÃ‘SÃ”SÃÃ˜$Ã%6Ã”7ÃÃ¥â€,Ã,?ÃM]Ã^Ã^Ã‘_Ã”_Ë† Ã° Ã—%Ã’%Â jÂ¸EÃ%Ã‘BÃ”BÃ—GÃ’GÃˆÃ‘LÃ”LË† Ã°
 PÃOÃOÃOÂ¸ÃOÃ‘OÃ”OÃÃ˜ gÃ gÃ gÃ gÃ>OÃ gÃ‘ gÃ” gÃÃ 
 Ã° 	:ÃÅ“:Â¥bÂ¤gÂ¨dÃ”.?Ã@UÃ”.VÃ]^Ã&_Ã‘&_Ã”&_Ã‘`Ã”`Ë†LÃ° 'pÃ&oÃ&oÃ&oÃ€GÃˆJÃ”DWÃ&oÃ‘&oÃ”&oÃ#Ãµ
 Ã*Ã‘+Ã”+Â­sÂ°7Â©|Â¬|Ã’;Ã;Ã)Â¨,Â¸Ã”8IÃJaÃ”8bÃ‘cÃ”cÃ—kÃ’kÃ‘mÃ”mÂ	Ã° '(Â¨!Â¨iÂ©-Ã‘&7Â Ëœ
Ã‘#Ã˜*/Â°'Â¸*Ã”2EÃ‘*EÃˆÃˆUÃ‰ÃV]Ã^hÃ”ViÃ‘HiÃ‘*iÂ ËœÃ‘'Ã'Ã +2Â°:Ã”+>ÂËœÃ‘(Ã(Ã &-Â¨jÃ”&9Ë†GÂNÃ‘#Ã Ã—&Ã’&Â ~Ã€Ã&Ã‘GÃ”GÃ—LÃ’LÃM^Ã‘_Ã”_Ë†Ã° â€”â€™Â Â¤
Â°*ÂÃ‘=Ã”=Ë†Ã˜ÃZÃZÃZÃ”[Ã[r#   c                 Ã³x   â€” | j         Â                     ddgdÂ¬Â¦  Â«        Â                     |Â¦  Â«        }|g dÂ¢         S )z9Return top popular anime based on score and member count.Ãš	scored_byrr   Frc   )r%   rQ   rO   rr   rs   )r   ry   rz   )r    ÃšnÃš populars      r!   rt   z-HybridRecommender.get_popular_recommendationsÂ¯   sB   â‚¬ Ã â€-Ã—+Ã’+Â¨[Â¸'Ã,BÃˆeÃ+Ã‘TÃ”TÃ—YÃ’YÃZ[Ã‘\Ã”\Ë† Ã˜ÃKÃKÃKÃ”LÃLr#   )N)rY   rZ   )rY   )	Ãš__name__Ãš
__module__Ãš__qualname__r"   r-   rM   rX   rÂ   rt   r1   r#   r!   r
   r
      sÂ   â‚¬ â‚¬ â‚¬ â‚¬ â‚¬ Ã°!Ã° !Ã° !Ã° !Ã°* iÃ°  iÃ°  iÃ°)Ã° )Ã° )Ã°>	?Ã° 	?Ã° 	?Ã°N\Ã° N\Ã° N\Ã° N\Ã°`MÃ° MÃ° MÃ° MÃ° MÃ° Mr#   r
   Ãš__main__r/   zRecommendations for user: rQ   rp   )Ãš __doc__Ãšpandasr)   Ãšnumpyru   Ãšsklearn.decompositionr   Ãšsklearn.feature_extraction.textr   Ãšsklearn.metrics.pairwiser   Ãšscipy.sparser   r   Ãš loggingÃš
basicConfigÃšINFOÃš	getLoggerrâ€   r'   r
   Ãš
recommenderr-   rM   rX   r   ÃšilocÃš
sample_userÃšprintrÂ   Ãšrecsr1   r#   r!   Ãº<module>rÂ¨      sÂ§  Ã°Ã°Ã° Ã° Ã Ã Ã Ã˜ Ã Ã Ã Ã˜ .Ã .Ã .Ã .Ã .Ã .Ã˜ ;Ã ;Ã ;Ã ;Ã ;Ã ;Ã˜ 2Ã 2Ã 2Ã 2Ã 2Ã 2Ã˜ #Ã #Ã #Ã #Ã #Ã #Ã˜ 	â‚¬	â‚¬	â‚¬	Ã˜ â‚¬â‚¬â‚¬Ã° â‚¬ Ã” Ëœ'Å“,Ã/ZÃ [Ã‘ [Ã” [Ã [Ã˜	Ë†Ã”	Ëœ8Ã‘	$Ã”	$â‚¬Ã°\MÃ° \MÃ° \MÃ° \MÃ° \MÃ± \MÃ´ \MÃ° \MÃ°| Ë†zÃ’ÃÃ #Ã#Ã‘%Ã”%â‚¬KÃ˜Ã—Ã’Ã‘Ã”ÃÃ˜Ã—Ã’Ã‘ Ã” Ã Ã˜Ã—Ã’Ã‘ Ã” Ã Ã° Ã”&Â zÃ”2Ã”7Â¸Ã”:â‚¬KÃ˜	â‚¬EÃ
4Â {Ã
4Ã
4Ã‘5Ã”5Ã5Ã˜
Ã—
 Ã’
 Â Ã‘
-Ã”
-â‚¬DÃ˜	â‚¬EË†$Â ËœÃ(Ã”
)Ã‘*Ã”*Ã*Ã*Ã*Ã° Ãr#   
